{{- if not (stat (joinPath .chezmoi.homeDir ".cache/chezmoi-install")) -}}
#!/usr/bin/zsh
# vim: ft=zsh

BLOCK_FILE="$HOME/.cache/chezmoi-install"

# check if this script has already been ran. Unnecessary with chezmoi template, but better safe than sorry
if [ -f "${BLOCK_FILE}" ]; then
    exit 0
else
    if [ "$EUID" != 0 ]; then
        mkdir -p "$(dirname $(realpath -m ${BLOCK_FILE}))"
        touch "${BLOCK_FILE}"
    fi
fi

### SPECIAL PRINT FUNCTIONS ###
ssp() {
    echo -en "\033[1m"
    echo -en "\033[32m"
    echo -n "==> "
    echo -en "\033[39m"
    echo -en "CHEZMOI: ${1}"
    echo -e "\033[0m"
}

sp() {
    echo -en "\033[1m"
    echo -en "\033[34m"
    echo -n "  -> "
    echo -en "\033[39m"
    echo -en "$1"
    echo -e "\033[0m"
}


### PACKAGE INSTALL ###

ssp "INSTALLING ALL PACKAGES"

# packages expected to already be installed: chezmoi dhcpcd [iwd] git linux-lts [nvidia-lts] sudo wget zsh

PACKAGES_SYS="ntfs-3g pam-u2f"
PACKAGES_TERMINAL="bat duf exa git git-lfs github-cli gum fzf xdg-user-dirs imagemagick unzip zip zsh wget lazygit pacman-contrib openssh man-db macchina-bin neovim ranger reflector ripgrep smbclient speedtest-cli sudo which zsh-theme-powerlevel10k-git"
PACKAGES_GUI="sway waybar eww-wayland-git gammastep swayidle swaylock-effects rofi-lbonn-wayland rofi-calc udiskie clipman discord dunst electrum firefox gnucash greetd greetd-tuigreet grim grimshot flameshot xdg-desktop-portal xdg-desktop-portal-wlr imagemagick git-credential-keepassxc keepassxc qt5-wayland kitty lxqt-openssh-askpass obsidian pipewire pipewire-alsa pipewire-jack pipewire-pulse wireplumber spotify syncthing teamviewer pavucontrol vlc xorg-server xorg-xwayland xfce4 xmousepasteblock-git"
PACKAGES_WORKSTATION="gimp blender bitwig-studio steam obs-studio"
PACKAGES_LAPTOP="acpi bluez brightnessctl tlp"

PACKAGES="${PACKAGES_TERMINAL}"

{{- if eq .chassistype "laptop" }}
sp "Including laptop packages"
PACKAGES="${PACKAGES} ${PACKAGES_SYS} ${PACKAGES_GUI} ${PACKAGES_LAPTOP}"
{{- else if eq .chassistype "desktop" }}
sp "Including workstation packages"
PACKAGES="${PACKAGES} ${PACKAGES_SYS} ${PACKAGES_GUI} ${PACKAGES_WORKSTATION}"
{{- end }}

# install all the packages
paru -Sy "${=PACKAGES}"

ssp "ALL PACKAGES INSTALLED"

# xdg-user-dirs
ssp "BEGINNING HOME FOLDER SETUP"

sp "Updating XDG user folders"
xdg-user-dirs-update

sp "Creating extra home folders"
mkdir "$HOME/rsync"
mkdir "$HOME/notes"

# nvim setup
sp "Starting headless Neovim install"
nvim --headless -c "autocmd User PackerComplete quitall"

sp "Installing Git LFS"
git lfs install

{{- if or (eq .chassistype "laptop") (eq .chassistype "desktop") -}}
### INIT SERVICES ###

sp "Enabling user systemd services"
systemctl enable --user pipewire.service
systemctl enable --user pipewire-pulse.service
systemctl enable --user flameshot.service
systemctl enable --user ssh-agent.service
systemctl enable --user udiskie.service

### CHEZMOI REMINDERS ###
sp "Generating post-install reminder file"
cat >>~/.cache/chezmoi-reminders.zsh <<EOL
#!/usr/bin/zsh

echo "Don't forget to configure the following stuff and things when you're ready:"

echo "After syncing password database with Syncthing, unlock it and run:"
echo "\$ git-credential-keepassxc configure"

echo "Delete ${0} to stop these reminders."
EOL

{{- else -}}
# prevent root setup script from running when this is a terminal-only install
touch "${HOME}/.cache/chezmoi-root"
ssp "TERMINAL-ONLY INSTALL COMPLETE. You'll need to install what you want manually... :)"
{{- end -}}
ssp "INSTALL UTILS SCRIPT COMPLETE"
{{- end -}}
