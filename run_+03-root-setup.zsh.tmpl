{{- if not (stat (joinPath .chezmoi.homeDir ".cache/chezmoi-root")) -}}
#!/usr/bin/zsh

BLOCK_FILE="$HOME/.cache/chezmoi-root"

# check if this script has already been ran. Unnecessary with chezmoi template, but better safe than sorry
if [ -f "${BLOCK_FILE}" ]; then
    exit 0
else
    if [ "$EUID" != 0 ]; then
        mkdir -p "$(dirname $(realpath -m ${BLOCK_FILE}))"
        touch "${BLOCK_FILE}"
    fi
fi

# run this script only as root, only after performing the above check
if [ "$EUID" != 0 ]; then
    echo "==> CHEZMOI: EXECUTING ROOT-ONLY SETUP"
    sudo "$0" "$@"
    exit $?
fi

### SPECIAL PRINT FUNCTIONS ###
ssp() {
    echo -en "\033[1m"
    echo -en "\033[32m"
    echo -n "==> "
    echo -en "\033[39m"
    echo -en "CHEZMOI: ${1}"
    echo -e "\033[0m"
}

sp() {
    echo -en "\033[1m"
    echo -en "\033[34m"
    echo -n "  -> "
    echo -en "\033[39m"
    echo -en "$1"
    echo -e "\033[0m"
}

# Run config setup stuff that can only be done as root

ssp "WRITING SYSTEM SCRIPTS"

{{- if eq .chassistype "desktop" }}
sp "Writing win-reboot-now script"

cat >>/usr/local/bin/win-reboot-now <<EOL
#!/bin/bash

# run this script only as root
if [ "\$EUID" != 0 ]; then
    sudo "\$0" "\$@"
    exit \$?
fi

efibootmgr -qn 0
systemctl reboot
EOL

chmod +x /usr/local/bin/win-reboot-now
{{- end }}

ssp "WRITING SYSTEM CONFIG FILES"

{{- if eq .chassistype "desktop" }}
sp "Writing win-reboot-now sudoer file"

cat >>/etc/sudoers.d/20-win-reboot <<EOL
greeter ALL=(ALL:ALL) NOPASSWD: /usr/local/bin/win-reboot-now
EOL
{{- end }}

# sshd
sp "Writing SSHD config"
mkdir -p /etc/ssh/sshd_config.d

cat >>/etc/ssh/sshd_config.d/10-chezmoi.conf <<EOL
Port 22
PermitRootLogin no
MaxAuthTries 3
PubkeyAuthentication yes
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
AllowAgentForwarding no
AllowTcpForwarding no
GatewayPorts no
X11Forwarding no
TCPKeepAlive yes
Compression delayed
EOL

# greetd
sp "Writing greetd config"
rm /etc/greetd/config.toml
cat >>/etc/greetd/config.toml <<EOL
[terminal]
vt = 1
[default_session]
{{- if eq .chassistype "desktop" }}
command = "tuigreet --remember --remember-session --power-reboot '/usr/local/bin/win-reboot-now'"
{{- else }}
command = "tuigreet --remember --remember-session"
{{- end }}
user = "greeter"
EOL

# systemd
sp "Writing systemd configs"
mkdir -p /etc/systemd/system.conf.d

{{- if eq .chassistype "laptop" }}
cat >>/etc/systemd/system.conf.d/10-chezmoi-framework.conf <<EOL
[Manager]
RebootWatchdogSec=0
EOL
{{- end }}

cat >>/etc/systemd/system.conf.d/20-chezmoi.conf <<EOL
[Manager]
DefaultTimeoutStopSec=10s
EOL

mkdir -p /etc/systemd/logind.conf.d

cat >>/etc/systemd/logind.conf.d/10-chezmoi.conf <<EOL
[Login]
HandlePowerKey=ignore
HandleSuspendKey=suspend
HandleHibernateKey=ignore
HandleLidSwitch=suspend
HandleLidSwitchExternalPower=ignore
HandleLidSwitchDocked=ignore
HandleRebootKey=ignore
IdleAction=suspend
IdleActionSec=300
EOL

### INIT SERVICES ###
sp "Enabling systemd services"
systemctl enable greetd.service
systemctl enable sshd.service
systemctl enable syncthing@{{- .chezmoi.username -}}.service
systemctl enable reflector.timer
systemctl start reflector.timer

# laptop services
{{- if eq .chassistype "laptop" }}
sp "Enabling laptop systemd services"
systemctl enable bluetooth.service
systemctl enable tlp.service
{{- end }}
ssp "ROOT SETUP SCRIPT COMPLETE"
{{- end -}}
